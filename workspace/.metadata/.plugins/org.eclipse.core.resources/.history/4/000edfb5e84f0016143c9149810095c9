package com.control;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

import com.dao.Dao;
import com.model.*;
/*
 * 用于将数据库返回的信息打包成公共传输类用于传输
 */
public class Control {
		
	//登陆，若登陆失败，原样返回
	public Common login(Common com) {
		if (com.getFlag() == 1) {//商户
			Userbusiness ub = (Userbusiness) com.getObject();
			if (Dao.checkBusinessLogin(ub.getAccount(), ub.getPassword()) == true) {
				//通过唯一的账号名查询再进行赋值
				ub.setId_business(Dao.getBusinessInfo(ub.getAccount()).getId_business());
				ub.setName(Dao.getBusinessInfo(ub.getAccount()).getName());
				return com;
			} 
		} else {//用户
			Usercustom uc = (Usercustom) com.getObject();
			if (Dao.checkCustomLogin(uc.getAccount(), uc.getPassword()) == true) {
				//通过唯一的账号名查询再进行赋值
				uc.setId_custom(Dao.getCustomInfo(uc.getAccount()).getId_custom());
				uc.setName(Dao.getCustomInfo(uc.getAccount()).getName());
				return com;
			} 
		}
		return com;
	}

	//注册
	public Common register(Common com) {
		if (com.getFlag() == 1) {//商户
			Userbusiness ub = (Userbusiness) com.getObject();
			Dao.insert("insert user_business values(NULL, '" + ub.getName() + "','"
					+ ub.getAccount() + "','" + ub.getPassword() + "')");
			ub.setId_business(Dao.getBusinessInfo(ub.getAccount()).getId_business());
			return com;
		} else {//用户
			Usercustom uc = (Usercustom) com.getObject();
			Dao.insert("insert user_custom values(NULL, '" + uc.getName() + "','"
					+ uc.getAccount() + "','" + uc.getPassword() + "')");
			uc.setId_custom(Dao.getCustomInfo(uc.getAccount()).getId_custom());
			return com;
		}
	}
	
	//添加菜单，不返回信息
	public void addCuisine(Common com) {
		Cuisine cs = (Cuisine)com.getObject();
		Dao.insert("insert into cuisine values(NULL, '" + cs.getId_business() + "', '"
				+ cs.getName() + "', '" + cs.getDescribe() + "', '" + cs.getPrice()  + "', '0')");
	}
	/*
	 *  显示菜单
	 * 1 显示全部
	 * 2 评分排序
	 * 3 销量排序
	 * 4 价格排序
	 */
	public Common showCuisine(Common com) {
		@SuppressWarnings("unchecked")
		List<Cuisine> cs = (ArrayList<Cuisine>) com.getObject();
		String condition = "";
		if (com.getFlag() == 1)
			condition = "";
		else if (com.getFlag() == 2)
			condition = " order by sales";
		else if (com.getFlag() == 3)
			condition = " order by price";
		else if (com.getFlag() == 4)
			condition = " order by star";
		ResultSet set = Dao.findForResultSet("select id_cuisine from cuisine" + condition);
		
		try {
			while (set.next()) {
				cs.add(Dao.getCuisineInfo(set.getInt("id_cuisine")));
			}
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		
		return com;
	}
	
	//删除菜单
	public void deleteCuisine(Common com) {
		Dao.delete("delete from cuisine where id_cuisine= '" + com.getFlag() + "'");
	}
	//显示订单
	public Common showOrder(Common com) {
		// TODO Auto-generated method stub
		return null;
	}
	//取消订单
	public void deleteOrder(Common com) {
		Order od = (Order)com.getObject();
		Dao.delete("delete from takeoutorder where id_order= '" + od.getId_order() + "'");
	}
	
	//添加订单
	public void addOrder(Common com) {
		Order od = (Order)com.getObject();
		//获取姓名的信息
		ResultSet set = Dao.findForResultSet("select cuisine.name, user_business.name "
				+ "from cuisine, user_business "
				+ "where cuisine.id_business = user_business.id_business "
				+ "and id_cuisine= '" + od.getId_cuisine() + "'");
		
		Dao.insert("insert into takeoutorder values(NULL, '" + od.getId_custom() + "', '"
		+ od.getId_cuisine() + "', '" + od.getNum() + "', '" + od.getTime() + "', '"
		+ od.getSpot() + "', '" + od.getStatus() + "')");
	}
	
	//修改菜单
	public void modefyCuisine(Common com) {
		Cuisine cs = (Cuisine)com.getObject();
		Dao.update("update cuisine set name  = '" + cs.getName() + "', miaoshu= '"
		+ cs.getDescribe() + "', price= '" + cs.getPrice() + "' where id_cuisine= '" + cs.getId_cuisine() + "', NULL");
	}
	//修改订单
	public Common modefyOrder(Common com) {
		Order od = (Order)com.getObject();
		Dao.update("update takeoutorder set status= '" + od.getStatus() + "', feedback= '" + od.getFeedback() + "' where id_order = '" + od.getId_order() + "'");
		return com;
	}
	/*public static void main(String args[]) {
		
		Common com1 = new Common();
		com1.setObject(new Userbusiness());
		Userbusiness ub = (Userbusiness)com1.getObject();
		ub.setName("wen");
		ub.setPassword("123");
		com1 = new Control().Login(com1);
		System.out.println("" + ((Userbusiness)com1.getObject()).getId_business());
	}*/
}
